# Story 4.2: Asset Review Gallery

## Status

Draft

## Story

**As a** content creator,  
**I want** an interactive gallery interface to review, select, and organize Pexels assets for video scenes,  
**so that** I can curate the perfect visual content and customize asset assignments before video generation.

## Acceptance Criteria

1. Gallery displays assets in responsive grid layout grouped by scene
2. Asset cards show thumbnails, metadata, and relevance scores with sorting options
3. Selection system allows choosing primary/alternative assets per scene
4. Preview functionality shows full-size assets with playback for videos
5. Scene assignment interface enables moving assets between scenes
6. Asset replacement system searches for alternatives to rejected content
7. Scene preview shows selected assets in sequence with timing visualization
8. Export functionality saves asset selections and triggers video generation
9. Search filtering finds specific assets by keyword, type, or quality metrics

## Tasks / Subtasks

- [ ] **Task 1: Create Asset Gallery Layout** (AC: 1, 9)
  - [ ] Create src/components/features/AssetReview/AssetGallery.tsx
  - [ ] Implement responsive grid system:
    - Scene-based grouping with collapsible sections
    - Masonry layout for varied aspect ratios
    - Infinite scroll with lazy loading
    - Mobile-optimized touch interactions
  - [ ] Add gallery navigation:
    - Scene tabs with asset counts
    - Jump-to-scene quick navigation
    - Breadcrumb navigation
    - Progress indicator per scene
  - [ ] Create search and filter bar:
    - Asset type filter (video/image)
    - Quality score range slider
    - Duration filter for videos
    - Keyword search across metadata
  - [ ] Apply responsive design with Tailwind

- [ ] **Task 2: Build Asset Card Components** (AC: 2, 4)
  - [ ] Create src/components/features/AssetReview/AssetCard.tsx
  - [ ] Implement asset display:
    - Thumbnail with aspect ratio preservation
    - Hover effects with scale animation
    - Overlay with asset metadata
    - Relevance score visualization
    - Asset type badge (video/image)
  - [ ] Add asset metadata display:
    - Photographer attribution
    - Resolution and duration info
    - Download count popularity
    - Keywords and tags
    - Pexels ID for tracking
  - [ ] Create interactive elements:
    - Click to preview functionality
    - Selection checkbox with state
    - Quick action buttons (select, reject, alternatives)
    - Drag handle for reordering
  - [ ] Add loading states and error handling

- [ ] **Task 3: Implement Asset Selection System** (AC: 3, 5)
  - [ ] Create src/services/assetSelection.ts
  - [ ] Build selection management:
    - Primary asset selection per scene
    - Alternative asset queue (2-3 backups)
    - Selection persistence in database
    - Multi-select for batch operations
  - [ ] Implement scene assignment:
    - Drag and drop between scenes
    - Scene coverage validation
    - Asset duration balance checking
    - Automatic scene rebalancing
  - [ ] Add selection validation:
    - Minimum assets per scene
    - Video vs image ratio requirements
    - Duration coverage validation
    - Quality threshold enforcement
  - [ ] Create selection state management with Zustand

- [ ] **Task 4: Create Asset Preview Modal** (AC: 4)
  - [ ] Create src/components/features/AssetReview/AssetPreview.tsx
  - [ ] Implement preview functionality:
    - Full-screen overlay modal
    - High-resolution image display
    - Video playback with controls
    - Navigation between assets
  - [ ] Add preview controls:
    - Play/pause for videos
    - Seek bar with thumbnails
    - Volume control
    - Fullscreen toggle
    - Download/share options
  - [ ] Build metadata sidebar:
    - Full photographer information
    - Complete asset metadata
    - Usage rights and attribution
    - Related asset suggestions
  - [ ] Create keyboard navigation:
    - Arrow keys for asset navigation
    - Spacebar for play/pause
    - Escape to close
    - Enter to select

- [ ] **Task 5: Build Scene Assignment Interface** (AC: 5, 7)
  - [ ] Create src/components/features/AssetReview/SceneAssignment.tsx
  - [ ] Implement scene organization:
    - Scene timeline visualization
    - Asset placement within scenes
    - Duration mapping with timing
    - Scene transition preview
  - [ ] Add assignment operations:
    - Drag assets between scenes
    - Clone assets to multiple scenes
    - Remove assets from scenes
    - Reorder assets within scenes
  - [ ] Create scene validation:
    - Scene coverage requirements
    - Asset timing verification
    - Quality distribution checking
    - Scene flow validation
  - [ ] Add scene preview:
    - Mini preview of scene flow
    - Asset sequence visualization
    - Timing estimates per scene
    - Visual consistency checking

- [ ] **Task 6: Implement Asset Replacement System** (AC: 6)
  - [ ] Create asset replacement service:
    - Find similar assets from search results
    - Generate alternative search queries
    - Quality-based replacement suggestions
    - Style consistency matching
  - [ ] Build replacement UI:
    - Replace asset button on cards
    - Alternative asset suggestions
    - Side-by-side comparison
    - Replacement confirmation dialog
  - [ ] Add search enhancement:
    - Similar asset discovery
    - Style-based recommendations
    - Color palette matching
    - Concept similarity scoring
  - [ ] Create replacement tracking:
    - Track replacement reasons
    - Monitor replacement success rates
    - Learn from replacement patterns
    - Improve suggestion algorithms

- [ ] **Task 7: Build Scene Flow Visualization** (AC: 7)
  - [ ] Create src/components/features/AssetReview/SceneFlow.tsx
  - [ ] Implement flow preview:
    - Horizontal timeline layout
    - Asset thumbnails in sequence
    - Timing indicators between assets
    - Scene boundaries visualization
  - [ ] Add flow controls:
    - Play sequence preview
    - Jump to specific assets
    - Adjust timing between assets
    - Scene transition effects preview
  - [ ] Create flow validation:
    - Visual consistency checking
    - Pacing analysis
    - Emotional arc validation
    - Style continuity verification
  - [ ] Add flow optimization:
    - Automatic asset reordering suggestions
    - Pacing improvement recommendations
    - Style consistency fixes
    - Flow enhancement tips

- [ ] **Task 8: Create Export and Generation Trigger** (AC: 8)
  - [ ] Build export functionality:
    - Save asset selections to database
    - Generate asset manifest JSON
    - Create scene-to-asset mappings
    - Validate selection completeness
  - [ ] Implement generation trigger:
    - Trigger video generation pipeline
    - Pass asset selections to renderer
    - Update script status to 'assets_approved'
    - Queue rendering job
  - [ ] Add export validation:
    - Check all scenes have assets
    - Verify asset accessibility
    - Validate scene coverage
    - Confirm quality standards
  - [ ] Create export confirmation:
    - Summary of selections
    - Estimated render time
    - Asset usage preview
    - Generation confirmation dialog

- [ ] **Task 9: Implement Advanced Filtering** (AC: 9)
  - [ ] Create advanced search system:
    - Multi-criteria filtering
    - Saved filter presets
    - Custom filter combinations
    - Filter history and favorites
  - [ ] Build search functionality:
    - Full-text search across metadata
    - Tag-based filtering
    - Color palette filtering
    - Photographer filtering
  - [ ] Add sorting options:
    - Relevance score sorting
    - Quality metric sorting
    - Date/popularity sorting
    - Custom sorting criteria
  - [ ] Create search analytics:
    - Track search patterns
    - Popular filter combinations
    - Search success rates
    - User preference learning

- [ ] **Task 10: Create Gallery State Management** (AC: 1, 3, 5)
  - [ ] Update src/stores/useAppStore.ts
  - [ ] Add asset gallery slice:
    - Asset grid state
    - Selection states
    - Filter and search states
    - Preview modal state
  - [ ] Implement gallery actions:
    - Load assets for script
    - Update asset selections
    - Handle scene assignments
    - Manage filter states
  - [ ] Add optimistic updates:
    - Immediate selection feedback
    - Drag operation previews
    - Search result updates
    - Preview state management
  - [ ] Create state persistence:
    - Save selection progress
    - Restore filter preferences
    - Maintain scroll positions
    - Cache asset data

## Dev Notes

### Architecture Context

- **Framework:** React 18 with TypeScript and Zustand state
- **UI Library:** Tailwind CSS with Framer Motion animations
- **Asset Display:** Masonry grid with intersection observer
- **Preview:** React Player for video, optimized image loading

### Component Hierarchy

```
AssetReview/
├── AssetGallery
│   ├── SceneSection[]
│   │   └── AssetCard[]
│   ├── AssetPreview (modal)
│   └── SearchFilters
├── SceneAssignment
│   ├── SceneTimeline
│   └── AssetDragDrop
└── SceneFlow
    ├── FlowVisualization
    └── FlowControls
```

### Asset Selection State

```typescript
interface AssetSelectionState {
  primaryAssets: Map<number, string>; // sceneNumber -> assetId
  alternativeAssets: Map<number, string[]>; // backups per scene
  rejectedAssets: Set<string>;
  sceneAssignments: Map<string, number[]>; // assetId -> sceneNumbers
  selectionProgress: SelectionProgress;
}
```

### Scene Coverage Algorithm

```typescript
// Ensure each scene has adequate visual coverage
function validateSceneCoverage(
  scene: SceneBreakdown,
  assets: Asset[]
): ValidationResult {
  const minDuration = scene.duration_estimate * 0.8; // 80% coverage minimum
  const assetDuration = assets.reduce(
    (total, asset) => total + asset.duration,
    0
  );

  return {
    isValid: assetDuration >= minDuration,
    coverage: assetDuration / scene.duration_estimate,
    recommendations: generateCoverageRecommendations(scene, assets),
  };
}
```

### Asset Quality Scoring

```typescript
// Visual quality and suitability scoring
function calculateDisplayScore(asset: Asset, scene: SceneBreakdown): number {
  return (
    asset.relevance_score * 0.4 + // Original relevance
    asset.technical_quality * 0.25 + // Resolution, clarity
    asset.aesthetic_appeal * 0.2 + // Visual composition
    calculateSceneFit(asset, scene) * 0.15 // Scene context match
  );
}
```

### Database Schema Updates

```sql
-- Asset selections and assignments
CREATE TABLE asset_selections (
  id TEXT PRIMARY KEY,
  script_id TEXT REFERENCES video_scripts(id),
  scene_number INTEGER,
  asset_id TEXT,
  selection_type TEXT CHECK (selection_type IN ('primary', 'alternative', 'rejected')),
  selection_order INTEGER,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Asset review sessions
CREATE TABLE asset_review_sessions (
  id TEXT PRIMARY KEY,
  script_id TEXT REFERENCES video_scripts(id),
  user_id TEXT,
  started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  completed_at TIMESTAMP,
  assets_reviewed INTEGER DEFAULT 0,
  selections_made INTEGER DEFAULT 0
);
```

### Performance Optimizations

```typescript
// Virtual scrolling for large asset collections
const AssetGrid = React.memo(() => {
  const { height, width } = useWindowDimensions();
  const itemSize = useMemo(() => calculateOptimalItemSize(width), [width]);

  return (
    <FixedSizeGrid
      height={height - 200}
      width={width}
      columnCount={Math.floor(width / itemSize)}
      rowHeight={itemSize * 1.2}
      itemData={assets}
    >
      {AssetCard}
    </FixedSizeGrid>
  );
});
```

### Testing Standards

- Component testing for gallery interactions
- Asset selection state management tests
- Drag and drop functionality tests
- Preview modal integration tests
- Performance testing with 100+ assets per scene

## Change Log

| Date       | Version | Description            | Author    |
| ---------- | ------- | ---------------------- | --------- |
| 2025-08-26 | 1.0     | Initial story creation | John (PM) |

## Dev Agent Record

(To be populated during implementation)

## QA Results

(To be populated during QA review)
