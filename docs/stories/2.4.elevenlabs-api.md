# Story 2.4: ElevenLabs API Integration

## Status

Draft

## Story

**As a** video producer,  
**I want** high-quality text-to-speech audio generation with precise timing data,  
**so that** I can create professional narration synchronized perfectly with visual scenes.

## Acceptance Criteria

1. ElevenLabs API key obtained and configured securely
2. TTS service generates audio from script content with selected voice
3. Word-level timing data extracted for audio-visual synchronization
4. Voice selection interface allows choosing appropriate narrator
5. Audio file management handles storage and organization
6. Web Speech API implemented as fallback for development/testing
7. Character usage monitoring prevents service suspension
8. Audio quality optimized for video production standards
9. Batch processing supports multiple script segments efficiently

## Tasks / Subtasks

- [ ] **Task 1: Setup ElevenLabs Account** (AC: 1, 7)
  - [ ] Visit https://elevenlabs.io (USER ACTION)
  - [ ] Create ElevenLabs account (USER ACTION)
  - [ ] Obtain API key from dashboard (USER ACTION)
  - [ ] Add ELEVENLABS_API_KEY to .env files (USER ACTION)
  - [ ] Review character limits and pricing
  - [ ] Document setup process in README

- [ ] **Task 2: Create ElevenLabs API Client** (AC: 1, 7)
  - [ ] Create src/services/elevenlabs/client.ts
  - [ ] Implement API client with:
    - API key authentication
    - Request/response typing
    - Character usage tracking
    - Error handling
    - Rate limiting awareness
  - [ ] Add usage monitoring:
    - Track character consumption
    - Monitor remaining quota
    - Alert before limits reached
  - [ ] Test API connectivity

- [ ] **Task 3: Implement Voice Management** (AC: 4)
  - [ ] Create src/services/elevenlabs/voices.ts
  - [ ] Implement voice discovery:
    - Fetch available voices
    - Cache voice metadata
    - Categorize by gender/accent/style
  - [ ] Create voice selection logic:
    - Default voice for motivational content
    - Voice switching per script style
    - Voice preview capability
  - [ ] Add voice quality preferences
  - [ ] Test voice variations

- [ ] **Task 4: Build TTS Generation Service** (AC: 2, 8)
  - [ ] Create src/services/elevenlabs/tts.ts
  - [ ] Implement generateAudio function:
    - Accept script content and voice ID
    - Split text into optimal chunks
    - Generate audio with quality settings
    - Combine audio segments
  - [ ] Optimize audio settings:
    - Sample rate: 44.1kHz
    - Bit depth: 16-bit
    - Format: MP3 or WAV
    - Quality: High fidelity
  - [ ] Add generation progress tracking
  - [ ] Test with various script lengths

- [ ] **Task 5: Extract Timing Data** (AC: 3)
  - [ ] Implement timing extraction:
    - Word-level timestamp parsing
    - Sentence boundary detection
    - Pause identification
    - Speed normalization
  - [ ] Create timing data structure:
    - Word positions in milliseconds
    - Sentence start/end times
    - Scene boundary markers
  - [ ] Add timing validation:
    - Verify timing accuracy
    - Check for gaps or overlaps
    - Validate total duration
  - [ ] Test timing precision

- [ ] **Task 6: Implement Audio File Management** (AC: 5)
  - [ ] Create audio storage system:
    - Organize files by script ID
    - Version control for regenerations
    - Metadata storage (duration, voice, etc.)
  - [ ] Add file operations:
    - Audio file validation
    - Format conversion if needed
    - File cleanup for old versions
  - [ ] Implement audio serving:
    - Stream audio files
    - Preview playback
    - Download capabilities
  - [ ] Test file management workflows

- [ ] **Task 7: Build Web Speech API Fallback** (AC: 6)
  - [ ] Create src/services/tts/webSpeech.ts
  - [ ] Implement fallback TTS:
    - Browser SpeechSynthesis API
    - Voice selection from available voices
    - Basic timing estimation
    - Audio recording capability
  - [ ] Add fallback detection:
    - Check ElevenLabs availability
    - Switch to fallback automatically
    - Notify user of fallback mode
  - [ ] Test fallback scenarios

- [ ] **Task 8: Implement Batch Processing** (AC: 9)
  - [ ] Create batch processing system:
    - Queue multiple TTS requests
    - Manage concurrent generations
    - Progress tracking for batches
    - Error handling for batch items
  - [ ] Optimize for character limits:
    - Smart text chunking
    - Minimize API calls
    - Efficient character usage
  - [ ] Add batch monitoring:
    - Track batch completion
    - Report batch statistics
    - Handle partial failures

- [ ] **Task 9: Create API Endpoints** (AC: 2, 4, 5)
  - [ ] Create src/routes/api/tts.ts
  - [ ] Implement endpoints:
    - POST /api/tts/generate - Generate audio
    - GET /api/tts/voices - List available voices
    - GET /api/tts/:id/audio - Stream audio file
    - GET /api/tts/:id/timing - Get timing data
    - GET /api/tts/usage - Character usage stats
  - [ ] Add request validation
  - [ ] Implement response formatting
  - [ ] Add error responses

## Dev Notes

### Architecture Context

- **Primary:** ElevenLabs API for high-quality TTS
- **Fallback:** Web Speech API for development
- **Audio Format:** MP3 for storage, WAV for processing
- **Timing Precision:** Word-level accuracy required

### ElevenLabs API Endpoints

```
Base URL: https://api.elevenlabs.io/v1

POST /text-to-speech/{voice_id}
GET /voices
GET /user/subscription

Headers:
xi-api-key: YOUR_API_KEY
Content-Type: application/json
```

### Voice Selection Strategy

```
Content Type â†’ Voice Selection:
- Motivational: Confident, warm voice
- Contemplative: Calm, thoughtful voice
- Urgent: Energetic, fast-paced voice
- Educational: Clear, professional voice
```

### Timing Data Structure

```typescript
interface TimingData {
  words: WordTiming[];
  sentences: SentenceTiming[];
  totalDuration: number;
  averageWPM: number;
}

interface WordTiming {
  word: string;
  start: number; // milliseconds
  end: number; // milliseconds
  confidence: number;
}
```

### Environment Variables

```
ELEVENLABS_API_KEY=your_api_key_here
ELEVENLABS_VOICE_ID=default_voice_id
ELEVENLABS_MODEL=eleven_monolingual_v1
ELEVENLABS_CHAR_LIMIT=10000
```

### Testing Standards

- Mock ElevenLabs API for testing
- Verify timing data accuracy
- Test fallback activation
- Validate audio quality
- Check character usage tracking

## Change Log

| Date       | Version | Description            | Author    |
| ---------- | ------- | ---------------------- | --------- |
| 2025-08-26 | 1.0     | Initial story creation | John (PM) |

## Dev Agent Record

(To be populated during implementation)

## QA Results

(To be populated during QA review)
