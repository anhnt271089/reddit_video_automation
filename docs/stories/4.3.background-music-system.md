# Story 4.3: Background Music System

## Status

Draft

## Story

**As a** content creator,  
**I want** an intelligent background music system that selects and manages audio tracks for video scenes,  
**so that** I can enhance videos with appropriate music that matches the emotional tone and pacing of each scene.

## Acceptance Criteria

1. Music library management stores and organizes royalty-free background tracks
2. Emotional tone analysis matches music tracks to script scene moods
3. Dynamic music selection chooses optimal tracks based on scene context
4. Audio processing handles track trimming, fading, and volume normalization
5. Scene-to-music mapping ensures smooth transitions between different tracks
6. Music customization allows manual track selection and timing adjustments
7. Audio mixing combines background music with voice narration at balanced levels
8. Copyright compliance ensures all tracks are properly licensed and attributed
9. Export functionality provides final audio tracks for video generation pipeline

## Tasks / Subtasks

- [ ] **Task 1: Build Music Library Management** (AC: 1, 8)
  - [ ] Create src/services/music/libraryManager.ts
  - [ ] Implement music library structure:
    - Categorized music storage (motivational, ambient, dramatic, etc.)
    - Metadata storage (duration, tempo, key, mood tags)
    - File organization with consistent naming
    - Duplicate detection and management
  - [ ] Add music ingestion system:
    - Bulk import from music directories
    - Audio file validation (format, quality, duration)
    - Automatic metadata extraction
    - License validation and tracking
  - [ ] Create library operations:
    - Search and filter by mood/tempo/genre
    - Preview playback functionality
    - Track rating and usage statistics
    - Library maintenance and cleanup
  - [ ] Build database schema for music metadata:
    - Track information storage
    - Usage history tracking
    - License and attribution data
    - Performance analytics

- [ ] **Task 2: Implement Emotional Tone Analysis** (AC: 2)
  - [ ] Create src/services/music/toneAnalysis.ts
  - [ ] Build tone detection system:
    - Audio analysis for tempo and rhythm
    - Harmonic analysis for emotional characteristics
    - Energy level detection (calm, moderate, high)
    - Musical mood classification
  - [ ] Implement scene-music matching:
    - Scene emotional tone extraction from script
    - Music track emotional profiling
    - Compatibility scoring algorithm
    - Mismatch detection and alternatives
  - [ ] Add tone categories:
    - Inspirational/Motivational (uplifting, driving)
    - Contemplative/Reflective (soft, thoughtful)
    - Dramatic/Urgent (intense, building tension)
    - Ambient/Background (neutral, non-distracting)
  - [ ] Create tone matching algorithm:
    - Multi-factor compatibility scoring
    - Scene transition consideration
    - Duration compatibility checking
    - Energy curve matching

- [ ] **Task 3: Build Dynamic Music Selection** (AC: 3, 5)
  - [ ] Create automated selection engine:
    - Scene analysis for music requirements
    - Track selection based on multiple factors
    - Fallback selection for edge cases
    - Selection validation and refinement
  - [ ] Implement selection criteria:
    - Emotional tone matching (40% weight)
    - Duration compatibility (25% weight)
    - Tempo appropriateness (20% weight)
    - Transition smoothness (15% weight)
  - [ ] Add scene transition logic:
    - Cross-fade planning between tracks
    - Key compatibility checking
    - Tempo transition smoothness
    - Emotional arc continuity
  - [ ] Create selection optimization:
    - Avoid repetitive track usage
    - Ensure track diversity across scenes
    - Optimize for overall video flow
    - Handle edge cases (very short/long scenes)

- [ ] **Task 4: Implement Audio Processing Pipeline** (AC: 4, 7)
  - [ ] Create src/services/music/audioProcessor.ts
  - [ ] Build audio manipulation tools:
    - Track trimming to scene duration
    - Fade-in/fade-out application
    - Volume normalization and balancing
    - Audio quality enhancement
  - [ ] Implement mixing capabilities:
    - Background music volume calculation
    - Voice narration priority handling
    - Dynamic range compression
    - Audio ducking for voice clarity
  - [ ] Add processing operations:
    - Seamless loop creation for long scenes
    - Cross-fade generation between tracks
    - Audio format standardization
    - Silence detection and removal
  - [ ] Create audio validation:
    - Quality assurance checks
    - Clipping detection and prevention
    - Phase correlation checking
    - Output format verification

- [ ] **Task 5: Create Music Customization Interface** (AC: 6)
  - [ ] Create src/components/features/MusicReview/MusicCustomizer.tsx
  - [ ] Build track selection UI:
    - Scene-by-scene music assignment
    - Alternative track suggestions
    - Manual track override options
    - Preview playback with scene timing
  - [ ] Implement timing controls:
    - Custom start/end point selection
    - Fade duration adjustment
    - Volume level control per scene
    - Transition timing modification
  - [ ] Add preview functionality:
    - Play scene with selected music
    - A/B testing between track options
    - Full video preview with music
    - Scene-specific audio adjustments
  - [ ] Create batch operations:
    - Apply music style to multiple scenes
    - Bulk track replacement
    - Mass volume adjustments
    - Style template application

- [ ] **Task 6: Build Scene-Music Mapping System** (AC: 5, 9)
  - [ ] Create mapping service:
    - Scene duration to music duration matching
    - Track segment assignment per scene
    - Transition point identification
    - Mapping validation and optimization
  - [ ] Implement mapping operations:
    - Automatic scene-track pairing
    - Manual mapping overrides
    - Mapping export for video pipeline
    - Mapping history and versioning
  - [ ] Add mapping validation:
    - Duration compatibility checks
    - Transition smoothness validation
    - Overall flow assessment
    - Gap detection and resolution
  - [ ] Create mapping optimization:
    - Minimize track changes per video
    - Optimize for emotional flow
    - Balance track variety and consistency
    - Handle complex scene structures

- [ ] **Task 7: Implement Copyright Compliance** (AC: 8)
  - [ ] Create license management system:
    - Track license type storage (Creative Commons, purchased, etc.)
    - Attribution requirement tracking
    - Usage rights validation
    - License expiration monitoring
  - [ ] Build compliance validation:
    - Pre-selection license checking
    - Usage rights verification
    - Attribution requirement flagging
    - Commercial use validation
  - [ ] Add attribution generation:
    - Automatic attribution text creation
    - Required credit formatting
    - Multiple attribution format support
    - Attribution placement guidance
  - [ ] Create compliance reporting:
    - License usage reports
    - Attribution compliance tracking
    - Rights violation detection
    - Legal requirement documentation

- [ ] **Task 8: Build Music Preview and Testing** (AC: 6, 7)
  - [ ] Create preview system:
    - Individual track preview with scene
    - Full video music preview
    - Side-by-side track comparisons
    - Scene transition preview
  - [ ] Implement testing tools:
    - Audio level measurement
    - Mixing quality assessment
    - Transition smoothness evaluation
    - Overall audio balance testing
  - [ ] Add preview controls:
    - Play/pause specific scenes
    - Skip to scene transitions
    - Adjust preview volume
    - Loop scene sections
  - [ ] Create testing metrics:
    - Audio level consistency
    - Transition quality scores
    - Emotional appropriateness ratings
    - Technical quality measurements

- [ ] **Task 9: Create Music Pipeline Integration** (AC: 9)
  - [ ] Build pipeline integration:
    - Generate final audio tracks per scene
    - Create audio manifest for video renderer
    - Export timing and volume data
    - Validate audio output quality
  - [ ] Implement export functionality:
    - Render final mixed audio tracks
    - Generate scene-specific audio files
    - Create audio metadata files
    - Package audio assets for video pipeline
  - [ ] Add pipeline coordination:
    - Trigger audio processing after asset approval
    - Coordinate with video generation system
    - Handle audio processing failures
    - Track audio pipeline progress
  - [ ] Create quality assurance:
    - Final audio quality validation
    - Export format verification
    - Metadata accuracy checking
    - Pipeline handoff confirmation

- [ ] **Task 10: Build Music Management API** (AC: 1, 3, 6)
  - [ ] Create src/routes/api/music.ts
  - [ ] Implement music endpoints:
    - GET /api/music/library - Browse music library
    - POST /api/music/select/:scriptId - Trigger music selection
    - GET /api/music/selections/:scriptId - Get scene-music mapping
    - PUT /api/music/customize/:scriptId - Update music assignments
    - POST /api/music/preview/:sceneId - Generate preview audio
  - [ ] Add music management endpoints:
    - POST /api/music/upload - Add tracks to library
    - GET /api/music/search - Search library by criteria
    - DELETE /api/music/tracks/:id - Remove tracks
    - GET /api/music/analytics - Usage statistics
  - [ ] Create response formatting:
    - Consistent API response structure
    - Error handling and validation
    - Audio streaming endpoints
    - Progress update WebSocket events
  - [ ] Test API functionality and performance

## Dev Notes

### Architecture Context

- **Audio Processing:** Node.js with `fluent-ffmpeg` for audio manipulation
- **Music Analysis:** Audio feature extraction for emotional tone matching
- **Storage:** File system for audio files, database for metadata
- **Streaming:** Audio preview streaming for UI playback

### Music Selection Algorithm

```typescript
interface MusicSelection {
  sceneId: string;
  trackId: string;
  startTime: number; // seconds into track
  endTime: number; // seconds into track
  fadeIn: number; // fade-in duration
  fadeOut: number; // fade-out duration
  volume: number; // 0-1 volume level
  transitionType: 'cut' | 'crossfade' | 'silence';
}

// Selection scoring algorithm
function scoreMusicTrack(track: MusicTrack, scene: SceneBreakdown): number {
  const toneMatch = calculateToneCompatibility(
    track.emotionalProfile,
    scene.emotional_tone
  );
  const durationFit = calculateDurationCompatibility(
    track.duration,
    scene.duration_estimate
  );
  const tempoFit = calculateTempoAppropriateness(track.tempo, scene.pacing);
  const transitionFit = calculateTransitionSmootness(track, previousTrack);

  return (
    toneMatch * 0.4 + durationFit * 0.25 + tempoFit * 0.2 + transitionFit * 0.15
  );
}
```

### Emotional Tone Categories

```typescript
interface EmotionalProfile {
  energy: number; // 0-10 (calm to energetic)
  valence: number; // 0-10 (sad to happy)
  tension: number; // 0-10 (relaxed to tense)
  tempo: number; // BPM
  genre: MusicGenre;
  tags: string[];
}

enum MusicGenre {
  AMBIENT = 'ambient',
  CINEMATIC = 'cinematic',
  ELECTRONIC = 'electronic',
  ACOUSTIC = 'acoustic',
  ORCHESTRAL = 'orchestral',
}
```

### Audio Processing Pipeline

```
Scene Analysis → Track Selection → Audio Processing →
Mixing & Balancing → Transition Creation →
Quality Validation → Export for Video Pipeline
```

### Database Schema Updates

```sql
-- Music library and metadata
CREATE TABLE music_tracks (
  id TEXT PRIMARY KEY,
  filename TEXT NOT NULL,
  title TEXT,
  artist TEXT,
  duration REAL,
  tempo INTEGER,
  key_signature TEXT,
  emotional_energy REAL,
  emotional_valence REAL,
  genre TEXT,
  license_type TEXT,
  attribution_required BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Scene music assignments
CREATE TABLE scene_music_assignments (
  id TEXT PRIMARY KEY,
  script_id TEXT REFERENCES video_scripts(id),
  scene_number INTEGER,
  track_id TEXT REFERENCES music_tracks(id),
  start_time REAL,
  end_time REAL,
  fade_in REAL DEFAULT 1.0,
  fade_out REAL DEFAULT 1.0,
  volume REAL DEFAULT 0.3,
  transition_type TEXT DEFAULT 'crossfade'
);

-- Music usage analytics
CREATE TABLE music_usage_stats (
  id TEXT PRIMARY KEY,
  track_id TEXT REFERENCES music_tracks(id),
  usage_count INTEGER DEFAULT 0,
  average_rating REAL,
  last_used TIMESTAMP,
  performance_score REAL
);
```

### Audio Mixing Configuration

```typescript
interface AudioMixingConfig {
  backgroundMusicLevel: number; // 0.2-0.4 typical
  voiceNarrationLevel: number; // 0.8-1.0 typical
  crossfadeDuration: number; // 1-3 seconds typical
  duckingAmount: number; // 0.1-0.3 reduction during speech
  normalizationTarget: number; // -23 LUFS for broadcast
}
```

### Performance Considerations

- Cache processed audio segments to avoid re-processing
- Use streaming for large audio file previews
- Implement background audio processing to not block UI
- Optimize memory usage during batch audio operations

### Testing Standards

- Audio processing unit tests with sample files
- Music selection algorithm validation tests
- Integration tests with video generation pipeline
- Performance tests with large music libraries
- Audio quality validation tests

## Change Log

| Date       | Version | Description            | Author    |
| ---------- | ------- | ---------------------- | --------- |
| 2025-08-26 | 1.0     | Initial story creation | John (PM) |

## Dev Agent Record

(To be populated during implementation)

## QA Results

(To be populated during QA review)
