# Story 3.5: Progressive Workflow UI States

## Status

Ready for Implementation

## Story

**As a** content curator,  
**I want** the UI to progressively reveal workflow buttons based on post status,  
**so that** I have clear visual guidance through the content approval and script generation process.

## Acceptance Criteria

1. **New Discovery State**: Fresh Reddit posts show only `Approve`, `Reject`, `View on Reddit` buttons
2. **Post-Approval State**: After approval, `Approve` button hides and `Generate Script` button appears
3. **Script Generation State**: `Generate Script` button shows "Generating Script..." with progress indication
4. **Script Complete State**: Button becomes "View Script Details" linking to script review interface
5. **Scripts List View**: `/scripts` page displays all generated scripts in organized list format
6. **Status Persistence**: UI states persist across page refreshes and browser sessions
7. **Real-time Updates**: WebSocket updates reflect state changes across multiple browser windows
8. **Error State Handling**: Failed generations show retry options without breaking workflow

## Tasks / Subtasks

### Task 1: Implement Progressive Button States (AC: 1-4)

- [ ] **Update PostCard component with state-based rendering**
  - [ ] Create button visibility logic based on `post.status`
  - [ ] Initial state: `status='discovered'` shows Approve/Reject/View buttons only
  - [ ] Approved state: `status='idea_selected'` shows Generate Script button
  - [ ] Generating state: `status='script_generating'` shows progress indicator
  - [ ] Complete state: `status='script_generated'` shows View Script Details button

### Task 2: Add Script Generation Status Tracking (AC: 3, 6)

- [ ] **Extend post status enum in shared types**
  ```typescript
  enum PostStatus {
    DISCOVERED = 'discovered',
    IDEA_SELECTED = 'idea_selected',
    SCRIPT_GENERATING = 'script_generating',
    SCRIPT_GENERATED = 'script_generated',
    SCRIPT_APPROVED = 'script_approved',
    REJECTED = 'rejected',
  }
  ```
- [ ] **Update database schema for new status values**
- [ ] **Modify approval workflow to set proper status progression**

### Task 3: Build Scripts List View (AC: 5)

- [ ] **Create `/scripts` page component**
  - [ ] List view of all generated scripts
  - [ ] Filter by status (generated, approved, in-review)
  - [ ] Search functionality for script titles
  - [ ] Sortable columns (date, title, status, quality score)
- [ ] **Add navigation link to scripts page**
- [ ] **Implement script detail view from list**

### Task 4: WebSocket Status Updates (AC: 7)

- [ ] **Extend WebSocket message types**
  ```typescript
  interface StatusUpdateMessage {
    type: 'post_status_update';
    postId: string;
    previousStatus: PostStatus;
    newStatus: PostStatus;
    timestamp: Date;
    metadata?: {
      scriptId?: string;
      progress?: number;
    };
  }
  ```
- [ ] **Update frontend WebSocket handlers for status changes**
- [ ] **Implement optimistic UI updates with rollback on error**

### Task 5: Error State Management (AC: 8)

- [ ] **Add error status handling**
  - [ ] `status='script_generation_failed'` shows retry button
  - [ ] Error message display with details
  - [ ] Retry mechanism with exponential backoff
- [ ] **Create error recovery workflow**
- [ ] **Add error analytics tracking**

## Component Changes Required

### PostCard.tsx Updates

```typescript
interface PostCardProps {
  post: RedditPost;
  // Remove always-visible handlers
  onApprove?: (postId: string) => void;
  onReject?: (postId: string) => void;
  onGenerateScript?: (postId: string) => void;
  onViewScript?: (postId: string) => void; // NEW
}

// Progressive button rendering logic
const renderActionButtons = () => {
  switch (post.status) {
    case 'discovered':
      return (
        <>
          <Button onClick={() => onApprove?.(post.id)}>âœ“ Approve</Button>
          <Button onClick={() => onReject?.(post.id)}>âœ— Reject</Button>
        </>
      );
    case 'idea_selected':
      return (
        <Button onClick={() => onGenerateScript?.(post.id)}>
          ðŸŽ¬ Generate Script
        </Button>
      );
    case 'script_generating':
      return (
        <Button disabled>
          <Spinner /> Generating Script...
        </Button>
      );
    case 'script_generated':
      return (
        <Button onClick={() => onViewScript?.(post.id)}>
          ðŸ“„ View Script Details
        </Button>
      );
  }
};
```

### New Scripts Page Component

```typescript
// src/pages/Scripts.tsx
interface Script {
  id: string;
  postId: string;
  title: string;
  status: ScriptStatus;
  createdAt: Date;
  qualityScore: number;
  wordCount: number;
  estimatedDuration: number;
}

const ScriptsListView = () => {
  // Table view with filtering and sorting
  // Link to individual script review interface
};
```

## Database Schema Changes

```sql
-- Update posts table status column
ALTER TABLE reddit_posts
DROP CONSTRAINT IF EXISTS posts_status_check;

ALTER TABLE reddit_posts
ADD CONSTRAINT posts_status_check
CHECK (status IN (
  'discovered',
  'idea_selected',
  'script_generating',
  'script_generated',
  'script_approved',
  'rejected'
));

-- Add status transition tracking
CREATE TABLE post_status_history (
  id TEXT PRIMARY KEY,
  post_id TEXT REFERENCES reddit_posts(id),
  previous_status TEXT,
  new_status TEXT,
  changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  changed_by TEXT,
  metadata JSON
);
```

## WebSocket Event Extensions

```typescript
// Add to existing WebSocket events
interface WebSocketEvents {
  post_status_update: {
    postId: string;
    status: PostStatus;
    metadata?: {
      scriptId?: string;
      progress?: number;
      error?: string;
    };
  };
  script_generation_progress: {
    postId: string;
    progress: number;
    currentStep: string;
  };
}
```

## Success Metrics

- [ ] UI buttons appear/disappear correctly based on post status
- [ ] Status changes propagate in real-time across browser sessions
- [ ] Scripts list page loads and displays all generated content
- [ ] Error states provide clear recovery paths
- [ ] Status transitions logged for analytics

## Definition of Done

- [ ] Progressive UI states implemented for all post statuses
- [ ] Scripts list view created with filtering and search
- [ ] WebSocket status updates working across multiple clients
- [ ] Error handling provides user-friendly retry mechanisms
- [ ] Status transitions persist across browser sessions
- [ ] All existing functionality preserved during refactor

## Change Log

| Date       | Version | Description            | Author            |
| ---------- | ------- | ---------------------- | ----------------- |
| 2025-09-03 | 1.0     | Initial story creation | BMad Orchestrator |
