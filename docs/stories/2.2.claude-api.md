# Story 2.2: Claude API Integration

## Status

Draft

## Story

**As a** content creator,  
**I want** AI-powered script generation from approved Reddit posts,  
**so that** I can automatically convert Reddit content into structured video scripts with scene breakdowns and metadata.

## Acceptance Criteria

1. Claude API client configured with existing subscription key
2. Structured prompt templates created for consistent script generation
3. Script generation service processes Reddit posts into structured output
4. Generated scripts include scene breakdown with timing estimates
5. YouTube metadata generated (titles, descriptions, thumbnails)
6. Token limit handling with content chunking for long posts
7. Error handling for API failures with retry logic
8. Script versioning system for iterative improvements
9. Generated content parsing validates all required fields

## Tasks / Subtasks

- [ ] **Task 1: Setup Claude API Client** (AC: 1)
  - [ ] Verify Claude API key in existing subscription (USER VERIFICATION)
  - [ ] Add CLAUDE_API_KEY to .env files
  - [ ] Create src/services/claude/client.ts
  - [ ] Implement API client with:
    - Request/response typing
    - Error handling
    - Rate limiting awareness
    - Request logging
  - [ ] Test connection with simple API call
  - [ ] Document API usage in README

- [ ] **Task 2: Design Prompt Templates** (AC: 2, 4, 5)
  - [ ] Create src/services/claude/prompts.ts
  - [ ] Design system prompt for video script generation:
    - Role definition as video script writer
    - Output format requirements
    - Tone and style guidelines
  - [ ] Create structured prompt template:
    - Reddit post context
    - Target video duration
    - Scene breakdown requirements
    - Keyword extraction needs
  - [ ] Design metadata prompt for:
    - 5 YouTube title variations
    - SEO-optimized description
    - Thumbnail concept suggestions
  - [ ] Test prompts with sample posts

- [ ] **Task 3: Implement Script Generation Service** (AC: 3, 9)
  - [ ] Create src/services/claude/scriptGenerator.ts
  - [ ] Implement generateScript function:
    - Accept RedditPost and duration target
    - Format prompt with post content
    - Call Claude API
    - Parse and validate response
  - [ ] Create response parsing logic:
    - Extract script content
    - Parse scene breakdown
    - Extract keywords per scene
    - Validate required fields
  - [ ] Add error handling for malformed responses
  - [ ] Create fallback prompts for edge cases

- [ ] **Task 4: Handle Long Content** (AC: 6)
  - [ ] Create content chunking utility
  - [ ] Implement token counting:
    - Estimate token usage
    - Split content at natural boundaries
    - Maintain context across chunks
  - [ ] Create chunk processing workflow:
    - Process chunks sequentially
    - Merge results coherently
    - Maintain scene continuity
  - [ ] Test with very long Reddit posts
  - [ ] Add chunking logging and metrics

- [ ] **Task 5: Create Script Versioning** (AC: 8)
  - [ ] Extend database schema for script versions
  - [ ] Implement version management:
    - Increment version on regeneration
    - Keep previous versions for rollback
    - Track generation parameters
  - [ ] Create version comparison utility
  - [ ] Add version selection in API
  - [ ] Test version workflows

- [ ] **Task 6: Implement Error Handling** (AC: 7)
  - [ ] Create comprehensive error handling:
    - API timeout errors
    - Rate limit errors
    - Invalid response errors
    - Network connectivity issues
  - [ ] Implement retry logic:
    - Exponential backoff
    - Maximum retry attempts
    - Different strategies per error type
  - [ ] Add circuit breaker pattern
  - [ ] Log all error scenarios

- [ ] **Task 7: Create API Endpoints** (AC: 3)
  - [ ] Create src/routes/api/scripts.ts
  - [ ] Implement endpoints:
    - POST /api/scripts - Generate new script
    - GET /api/scripts/:id - Retrieve script
    - POST /api/scripts/:id/regenerate - Regenerate script
    - GET /api/scripts/:id/versions - Get all versions
  - [ ] Add request validation
  - [ ] Implement response formatting
  - [ ] Add error responses

- [ ] **Task 8: Add Content Validation** (AC: 9)
  - [ ] Create content validation service:
    - Validate script structure
    - Check scene breakdown format
    - Verify keyword extraction
    - Validate metadata completeness
  - [ ] Implement quality scoring:
    - Script length appropriateness
    - Scene transition quality
    - Keyword relevance
  - [ ] Add validation to generation pipeline
  - [ ] Create validation reports

## Dev Notes

### Architecture Context

- **API:** Anthropic Claude API (existing subscription)
- **Model:** Claude 3.5 Sonnet recommended
- **Rate Limits:** 50 requests/minute typical
- **Token Limits:** ~200K tokens per request

### Prompt Engineering Strategy

```
System Prompt:
- Role: Professional video script writer
- Style: Motivational content specialist
- Output: Structured JSON format
- Constraints: Target duration, scene count

User Prompt Template:
- Reddit post context
- Duration target (30-120 seconds)
- Scene breakdown (3-7 scenes)
- Keyword extraction per scene
```

### Generated Script Structure

```typescript
interface GeneratedScript {
  script_content: string;
  scene_breakdown: SceneData[];
  duration_target: number;
  titles: string[]; // 5 variations
  description: string;
  thumbnail_suggestions: ThumbnailConcept[];
  keywords: string[];
}
```

### Environment Variables

```
CLAUDE_API_KEY=your_api_key_here
CLAUDE_MODEL=claude-3-sonnet-20240229
CLAUDE_MAX_TOKENS=4096
```

### Testing Standards

- Mock Claude API for consistent testing
- Test with various Reddit post lengths
- Verify all output fields present
- Test error scenarios and retries
- Validate generated content quality

## Change Log

| Date       | Version | Description            | Author    |
| ---------- | ------- | ---------------------- | --------- |
| 2025-08-26 | 1.0     | Initial story creation | John (PM) |

## Dev Agent Record

(To be populated during implementation)

## QA Results

(To be populated during QA review)
