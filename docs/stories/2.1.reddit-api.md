# Story 2.1: Reddit API Integration

## Status

Draft

## Story

**As a** content curator,  
**I want** automated Reddit content discovery from r/getmotivated,  
**so that** I have a continuous stream of high-quality content for video creation without manual browsing.

## Acceptance Criteria

1. Reddit OAuth2 authentication flow implemented with secure token storage
2. Reddit API client service created with proper error handling
3. Rate limiting enforced at 60 requests per minute with queuing
4. Subreddit scraping retrieves posts with all metadata (title, content, upvotes, comments, author, date)
5. Posts stored in database with engagement metrics and discovery timestamp
6. Automatic token refresh before expiration
7. Caching layer reduces redundant API calls by 50%
8. Manual trigger and scheduled scraping both supported
9. Error recovery for failed API calls with exponential backoff

## Tasks / Subtasks

- [ ] **Task 1: Setup Reddit App Registration** (AC: 1)
  - [ ] Create Reddit account if needed (USER ACTION)
  - [ ] Navigate to https://www.reddit.com/prefs/apps (USER ACTION)
  - [ ] Create new app with type "script" (USER ACTION)
  - [ ] Document client ID and secret in .env (USER ACTION)
  - [ ] Add redirect URI http://localhost:3001/auth/reddit/callback
  - [ ] Document app setup process in README

- [ ] **Task 2: Implement OAuth2 Authentication** (AC: 1, 6)
  - [ ] Create src/services/reddit/auth.ts
  - [ ] Implement OAuth2 flow:
    - Authorization URL generation
    - Token exchange endpoint
    - Refresh token logic
  - [ ] Store tokens securely in database
  - [ ] Create token refresh scheduler
  - [ ] Add token validation middleware
  - [ ] Test authentication flow

- [ ] **Task 3: Create Reddit API Client** (AC: 2, 9)
  - [ ] Create src/services/reddit/client.ts
  - [ ] Implement base request wrapper with:
    - Authorization headers
    - Error handling
    - Retry logic with exponential backoff
    - Response parsing
  - [ ] Create typed interfaces for Reddit responses
  - [ ] Add logging for all API calls
  - [ ] Handle common Reddit API errors

- [ ] **Task 4: Implement Rate Limiting** (AC: 3)
  - [ ] Create src/utils/rateLimiter.ts
  - [ ] Implement token bucket algorithm:
    - 60 requests per minute limit
    - Request queuing when limit reached
    - Priority queue for important requests
  - [ ] Add rate limit headers parsing
  - [ ] Create rate limit monitoring
  - [ ] Test with burst requests

- [ ] **Task 5: Build Subreddit Scraper** (AC: 4, 5)
  - [ ] Create src/services/reddit/scraper.ts
  - [ ] Implement post fetching:
    - GET /r/getmotivated/top?time=week
    - GET /r/getmotivated/hot
    - GET /r/getmotivated/new
  - [ ] Parse post data:
    - Extract all metadata fields
    - Handle different post types (text, link, image)
    - Calculate engagement score
  - [ ] Store posts in database:
    - Check for duplicates by reddit_id
    - Update existing posts with new metrics
    - Set initial status as 'idea'

- [ ] **Task 6: Implement Caching Layer** (AC: 7)
  - [ ] Create src/services/reddit/cache.ts
  - [ ] Implement in-memory cache with:
    - TTL of 15 minutes for post data
    - Cache invalidation on updates
    - Cache warming on startup
  - [ ] Add cache hit/miss logging
  - [ ] Create cache statistics endpoint
  - [ ] Test cache effectiveness

- [ ] **Task 7: Create API Endpoints** (AC: 8)
  - [ ] Create src/routes/api/reddit.ts
  - [ ] Implement endpoints:
    - POST /api/reddit/scrape - Manual trigger
    - GET /api/reddit/posts - Retrieve stored posts
    - GET /api/reddit/status - API health status
  - [ ] Add request validation
  - [ ] Implement response formatting
  - [ ] Add error responses

- [ ] **Task 8: Setup Scheduled Scraping** (AC: 8)
  - [ ] Create src/jobs/redditScraper.ts
  - [ ] Implement cron job:
    - Run every 4 hours
    - Scrape top posts from past week
    - Log results
  - [ ] Add job monitoring
  - [ ] Create manual job trigger
  - [ ] Handle job failures gracefully

## Dev Notes

### Architecture Context

- **API Version:** Reddit API v1
- **Authentication:** OAuth2 with refresh tokens
- **Rate Limits:** 60 req/min per OAuth client
- **Data Source:** r/getmotivated subreddit only

### Reddit API Endpoints

```
Base URL: https://oauth.reddit.com

GET /api/v1/me - Verify authentication
GET /r/{subreddit}/top - Top posts
GET /r/{subreddit}/hot - Hot posts
GET /r/{subreddit}/new - New posts
```

### Scoring Algorithm

Calculate engagement score based on:

- Upvotes (weighted 40%)
- Comments (weighted 30%)
- Upvote ratio (weighted 20%)
- Age decay factor (weighted 10%)

### Environment Variables

```
REDDIT_CLIENT_ID=your_client_id
REDDIT_CLIENT_SECRET=your_secret
REDDIT_USER_AGENT=video-automation/1.0
REDDIT_REDIRECT_URI=http://localhost:3001/auth/reddit/callback
```

### Testing Standards

- Mock Reddit API responses for unit tests
- Test rate limiting with concurrent requests
- Verify token refresh logic
- Test error recovery scenarios
- Check cache hit rates

## Change Log

| Date       | Version | Description            | Author    |
| ---------- | ------- | ---------------------- | --------- |
| 2025-08-26 | 1.0     | Initial story creation | John (PM) |

## Dev Agent Record

(To be populated during implementation)

## QA Results

(To be populated during QA review)
