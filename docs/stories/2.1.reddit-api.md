# Story 2.1: Reddit API Integration

## Status

Approved

## Story

**As a** content curator,  
**I want** automated Reddit content discovery from r/getmotivated,  
**so that** I have a continuous stream of high-quality content for video creation without manual browsing.

## Acceptance Criteria

1. Reddit OAuth2 authentication flow implemented with secure token storage
2. Reddit API client service created with proper error handling
3. Rate limiting enforced at 60 requests per minute with queuing
4. Subreddit scraping retrieves posts with all metadata (title, content, upvotes, comments, author, date)
5. Posts stored in database with engagement metrics and discovery timestamp
6. Automatic token refresh before expiration
7. Caching layer reduces redundant API calls by 50%
8. Manual trigger and scheduled scraping both supported
9. Error recovery for failed API calls with exponential backoff

## Tasks / Subtasks

- [x] **Task 1: Setup Reddit App Registration** (AC: 1)
  - [x] Create Reddit account if needed (USER ACTION)
  - [x] Navigate to https://www.reddit.com/prefs/apps (USER ACTION)
  - [x] Create new app with type "script" (USER ACTION)
  - [x] Document client ID and secret in .env (USER ACTION)
  - [x] Add redirect URI http://localhost:3001/auth/reddit/callback
  - [ ] Document app setup process in README

- [x] **Task 2: Implement OAuth2 Authentication** (AC: 1, 6)
  - [x] Create src/services/reddit/auth.ts
  - [x] Implement OAuth2 flow:
    - Authorization URL generation
    - Token exchange endpoint
    - Refresh token logic
  - [x] Store tokens securely in database
  - [x] Create token refresh scheduler
  - [x] Add token validation middleware
  - [x] Test authentication flow

- [x] **Task 3: Create Reddit API Client** (AC: 2, 9)
  - [x] Create src/services/reddit/client.ts
  - [x] Implement base request wrapper with:
    - Authorization headers
    - Error handling
    - Retry logic with exponential backoff
    - Response parsing
  - [x] Create typed interfaces for Reddit responses
  - [x] Add logging for all API calls
  - [x] Handle common Reddit API errors

- [x] **Task 4: Implement Rate Limiting** (AC: 3)
  - [x] Create src/utils/rateLimiter.ts
  - [x] Implement token bucket algorithm:
    - 60 requests per minute limit
    - Request queuing when limit reached
    - Priority queue for important requests
  - [x] Add rate limit headers parsing
  - [x] Create rate limit monitoring
  - [x] Test with burst requests

- [ ] **Task 5: Build Subreddit Scraper** (AC: 4, 5)
  - [ ] Create src/services/reddit/scraper.ts
  - [ ] Implement post fetching:
    - GET /r/getmotivated/top?time=week
    - GET /r/getmotivated/hot
    - GET /r/getmotivated/new
  - [ ] Parse post data:
    - Extract all metadata fields
    - Handle different post types (text, link, image)
    - Calculate engagement score
  - [ ] Store posts in database:
    - Check for duplicates by reddit_id
    - Update existing posts with new metrics
    - Set initial status as 'idea'

- [ ] **Task 6: Implement Caching Layer** (AC: 7)
  - [ ] Create src/services/reddit/cache.ts
  - [ ] Implement in-memory cache with:
    - TTL of 15 minutes for post data
    - Cache invalidation on updates
    - Cache warming on startup
  - [ ] Add cache hit/miss logging
  - [ ] Create cache statistics endpoint
  - [ ] Test cache effectiveness

- [ ] **Task 7: Create API Endpoints** (AC: 8)
  - [ ] Create src/routes/api/reddit.ts
  - [ ] Implement endpoints:
    - POST /api/reddit/scrape - Manual trigger
    - GET /api/reddit/posts - Retrieve stored posts
    - GET /api/reddit/status - API health status
  - [ ] Add request validation
  - [ ] Implement response formatting
  - [ ] Add error responses

- [ ] **Task 8: Setup Scheduled Scraping** (AC: 8)
  - [ ] Create src/jobs/redditScraper.ts
  - [ ] Implement cron job:
    - Run every 4 hours
    - Scrape top posts from past week
    - Log results
  - [ ] Add job monitoring
  - [ ] Create manual job trigger
  - [ ] Handle job failures gracefully

## Dev Notes

### Architecture Context

- **API Version:** Reddit API v1
- **Authentication:** OAuth2 with refresh tokens
- **Rate Limits:** 60 req/min per OAuth client
- **Data Source:** r/getmotivated subreddit only

### Reddit API Endpoints

```
Base URL: https://oauth.reddit.com

GET /api/v1/me - Verify authentication
GET /r/{subreddit}/top - Top posts
GET /r/{subreddit}/hot - Hot posts
GET /r/{subreddit}/new - New posts
```

### Scoring Algorithm

Calculate engagement score based on:

- Upvotes (weighted 40%)
- Comments (weighted 30%)
- Upvote ratio (weighted 20%)
- Age decay factor (weighted 10%)

### Environment Variables

```
REDDIT_CLIENT_ID=your_client_id
REDDIT_CLIENT_SECRET=your_secret
REDDIT_USER_AGENT=video-automation/1.0
REDDIT_REDIRECT_URI=http://localhost:3001/auth/reddit/callback
```

### Testing Standards

- Mock Reddit API responses for unit tests
- Test rate limiting with concurrent requests
- Verify token refresh logic
- Test error recovery scenarios
- Check cache hit rates

## Change Log

| Date       | Version | Description            | Author    |
| ---------- | ------- | ---------------------- | --------- |
| 2025-08-26 | 1.0     | Initial story creation | John (PM) |

## Dev Agent Record

### Task 2 & 3 Implementation (2025-08-26)

- **OAuth2 Authentication Service** (`src/services/reddit/auth.ts`):
  - Complete OAuth2 flow with authorization URL generation and token exchange
  - Secure token storage in SQLite database with automatic refresh logic
  - Token validation and connection testing capabilities
  - Comprehensive error handling and logging

- **Reddit API Client** (`src/services/reddit/client.ts`):
  - Base request wrapper with Bearer token authentication
  - Exponential backoff retry logic with rate limiting support (429 responses)
  - No retries for authentication errors (401/403) - throws immediately
  - Comprehensive TypeScript interfaces for all Reddit API responses
  - Methods: `getUserInfo`, `getSubredditInfo`, `getSubredditPosts`, `getTopPosts`, `searchPosts`, `getPost`, `testConnection`
  - Full test coverage (16 tests) with mocked Reddit API responses

- **Token Scheduler** (`src/services/reddit/tokenScheduler.ts`):
  - Automatic token refresh every 30 minutes
  - Manual refresh capabilities
  - Graceful error handling and status monitoring

**Files Created:**

- `src/services/reddit/auth.ts` (357 lines)
- `src/services/reddit/client.ts` (367 lines)
- `src/services/reddit/client.test.ts` (505 lines)
- `src/services/reddit/tokenScheduler.ts` (100 lines)

**Testing:** All tests pass, code passes ESLint and TypeScript checks

### Task 4 Implementation (2025-08-26)

- **Rate Limiter Service** (`src/utils/rateLimiter.ts`):
  - Complete token bucket algorithm implementation with 60 requests/minute limit (1 request/second with burst capacity)
  - Priority queue system with endpoint-based priority assignments (auth: 10, about: 8, top/hot: 6, search: 4, new: 2)
  - Request queuing and automatic processing when tokens become available
  - Rate limit headers parsing from Reddit API responses (x-ratelimit-remaining, x-ratelimit-reset)
  - Comprehensive statistics tracking (total requests, throttled requests, average wait time, queue size)
  - Graceful cleanup and queue management

- **Reddit API Client Integration** (`src/services/reddit/client.ts`):
  - Integrated rate limiter into makeRequest method with priority-based token acquisition
  - Automatic rate limit header parsing and token synchronization
  - Priority-based endpoint classification for optimal API usage
  - Rate limiter statistics exposure via getRateLimiterStats() method

- **API Monitoring Endpoints** (`src/routes/api/reddit.ts`):
  - GET /api/reddit/status - comprehensive API health including rate limit status
  - GET /api/reddit/rate-limit - detailed rate limiter statistics and metrics
  - POST /api/reddit/scrape - manual scraping trigger with rate limiting
  - GET /api/reddit/posts - placeholder for future database integration

- **Comprehensive Testing** (`src/utils/rateLimiter.test.ts`):
  - 13 test cases covering token bucket algorithm, request queuing, priority handling
  - Burst request testing with fake timers for deterministic behavior
  - Header integration testing and error handling
  - Statistics tracking and queue management validation
  - Updated Reddit client tests with proper rate limiter mocking

**Files Created/Modified:**

- `src/utils/rateLimiter.ts` (273 lines) - Core rate limiting implementation
- `src/utils/rateLimiter.test.ts` (299 lines) - Comprehensive test suite
- `src/routes/api/reddit.ts` (121 lines) - Reddit API endpoints with monitoring
- `src/routes/api/index.ts` - Updated to include Reddit routes
- `src/services/reddit/client.ts` - Integrated rate limiting with priority system

**Key Features:**

- Token bucket with 60 requests/minute (1/second) with 60 token burst capacity
- Priority queue processing (higher priority requests processed first)
- Rate limit header synchronization with Reddit API
- Request queuing with automatic processing when tokens available
- Comprehensive monitoring and statistics collection
- Graceful error handling and queue cleanup

**Testing:** All 29 tests pass across rate limiter and Reddit client suites, code passes ESLint and TypeScript checks

## QA Results

(To be populated during QA review)
