# Story 5.3: Video Preview System

## Status

Draft

## Story

**As a** content creator,  
**I want** a fast preview system that generates low-quality video previews for review before full rendering,  
**so that** I can validate video composition, timing, and visual elements without waiting for high-quality renders.

## Acceptance Criteria

1. Fast preview generation creates low-quality videos in under 30 seconds
2. Preview player supports standard video controls with timeline scrubbing
3. Scene-by-scene navigation allows jumping to specific video sections
4. Preview comparison shows before/after edits side-by-side
5. Thumbnail generation creates preview frames at regular intervals
6. Preview sharing enables collaboration with stakeholders via shareable links
7. Preview feedback system allows comments and annotations on specific timestamps
8. Preview caching stores generated previews for instant replay
9. Preview quality options balance speed vs visual fidelity based on use case

## Tasks / Subtasks

- [ ] **Task 1: Build Fast Preview Generator** (AC: 1, 9)
  - [ ] Create src/services/video/previewGenerator.ts
  - [ ] Implement low-quality rendering:
    - Reduced resolution rendering (480p/720p)
    - Lower bitrate encoding settings
    - Simplified visual effects
    - Optimized compression for speed
  - [ ] Add preview optimization:
    - Frame rate reduction (15-24 fps)
    - Asset quality downsampling
    - Effect complexity reduction
    - Audio quality compression
  - [ ] Create rendering shortcuts:
    - Skip non-essential visual effects
    - Use proxy assets for large files
    - Implement progressive rendering
    - Cache intermediate processing steps
  - [ ] Build preview queue management:
    - Priority queue for urgent previews
    - Background preview generation
    - Resource-aware processing
    - Cancellation support

- [ ] **Task 2: Create Preview Player Interface** (AC: 2, 3)
  - [ ] Create src/components/features/VideoPreview/PreviewPlayer.tsx
  - [ ] Implement video player controls:
    - Play/pause functionality
    - Timeline scrubbing with thumbnails
    - Volume control
    - Fullscreen toggle
    - Playback speed adjustment
  - [ ] Add navigation features:
    - Scene markers on timeline
    - Jump-to-scene buttons
    - Previous/next scene navigation
    - Bookmark creation and navigation
    - Loop playback options
  - [ ] Create player customization:
    - Player skin themes
    - Control layout options
    - Keyboard shortcut support
    - Mobile-optimized controls
  - [ ] Build player state management:
    - Playback position persistence
    - Volume preferences
    - Playback speed memory
    - Recent playback history

- [ ] **Task 3: Implement Scene Navigation** (AC: 3)
  - [ ] Create scene-based navigation system:
    - Scene timeline visualization
    - Scene duration indicators
    - Scene transition markers
    - Visual scene boundaries
  - [ ] Add scene interaction features:
    - Click-to-jump scene navigation
    - Scene preview thumbnails
    - Scene duration display
    - Scene title overlays
  - [ ] Build scene analysis tools:
    - Scene content summaries
    - Scene quality indicators
    - Scene timing validation
    - Scene flow visualization
  - [ ] Create scene editing shortcuts:
    - Quick scene adjustments
    - Scene replacement options
    - Scene duration modifications
    - Scene reordering interface

- [ ] **Task 4: Build Preview Comparison System** (AC: 4)
  - [ ] Create src/components/features/VideoPreview/ComparisonViewer.tsx
  - [ ] Implement side-by-side comparison:
    - Dual preview player layout
    - Synchronized playback controls
    - Version selection interface
    - Difference highlighting
  - [ ] Add comparison tools:
    - Frame-by-frame comparison
    - Overlay comparison mode
    - Split-screen viewing
    - Before/after slider
  - [ ] Create comparison analytics:
    - Visual difference detection
    - Quality improvement metrics
    - Change impact analysis
    - Version performance comparison
  - [ ] Build comparison sharing:
    - Comparison link generation
    - Annotated comparison exports
    - Stakeholder review workflows
    - Approval tracking

- [ ] **Task 5: Implement Thumbnail Generation** (AC: 5)
  - [ ] Create thumbnail extraction system:
    - Regular interval thumbnail capture
    - Scene representative frame selection
    - Key moment identification
    - Smart thumbnail optimization
  - [ ] Build thumbnail management:
    - Thumbnail caching system
    - Thumbnail quality options
    - Batch thumbnail generation
    - Thumbnail update triggers
  - [ ] Add thumbnail features:
    - Hover thumbnail previews
    - Thumbnail-based navigation
    - Custom thumbnail selection
    - Thumbnail annotation support
  - [ ] Create thumbnail optimization:
    - Compression for fast loading
    - Multiple resolution support
    - Lazy loading implementation
    - CDN integration for delivery

- [ ] **Task 6: Build Preview Sharing System** (AC: 6)
  - [ ] Create sharing functionality:
    - Shareable preview link generation
    - Access control and permissions
    - Temporary link expiration
    - Password-protected sharing
  - [ ] Implement collaboration features:
    - Stakeholder invitation system
    - Role-based access control
    - View-only vs comment permissions
    - External user access management
  - [ ] Add sharing analytics:
    - View tracking and analytics
    - User engagement metrics
    - Share link performance
    - Access pattern analysis
  - [ ] Create sharing security:
    - Link encryption and obfuscation
    - IP-based access restrictions
    - Time-limited access tokens
    - Audit logging for access

- [ ] **Task 7: Implement Feedback and Annotation System** (AC: 7)
  - [ ] Create src/components/features/VideoPreview/FeedbackSystem.tsx
  - [ ] Build annotation tools:
    - Timestamp-based comments
    - Visual annotation markers
    - Drawing and highlighting tools
    - Text note attachments
  - [ ] Implement feedback collection:
    - Structured feedback forms
    - Rating and approval systems
    - Issue categorization
    - Priority feedback flagging
  - [ ] Add collaboration features:
    - Real-time comment threads
    - @mention notifications
    - Reply and discussion threads
    - Resolution status tracking
  - [ ] Create feedback management:
    - Feedback filtering and sorting
    - Bulk feedback operations
    - Feedback export functionality
    - Integration with project management

- [ ] **Task 8: Build Preview Caching System** (AC: 8)
  - [ ] Create intelligent caching:
    - Preview file caching
    - Thumbnail cache management
    - Metadata caching
    - Progressive cache warming
  - [ ] Implement cache strategies:
    - LRU cache eviction
    - Cache size management
    - Cache hit optimization
    - Cache invalidation triggers
  - [ ] Add cache persistence:
    - Database cache metadata
    - File system cache storage
    - Cloud storage integration
    - Cache synchronization
  - [ ] Create cache monitoring:
    - Cache hit rate tracking
    - Storage usage monitoring
    - Cache performance analytics
    - Cache optimization suggestions

- [ ] **Task 9: Implement Quality Options** (AC: 9)
  - [ ] Create quality tier system:
    - Draft quality (fastest, lowest quality)
    - Review quality (balanced speed/quality)
    - Preview quality (high quality, slower)
    - Custom quality settings
  - [ ] Build adaptive quality:
    - Automatic quality selection
    - Network-aware quality adjustment
    - Device capability detection
    - User preference learning
  - [ ] Add quality controls:
    - Manual quality override
    - Quality comparison tools
    - Quality impact visualization
    - Quality recommendation system
  - [ ] Create quality optimization:
    - Smart quality algorithms
    - Content-aware quality adjustment
    - Performance-based quality tuning
    - Quality vs speed analytics

- [ ] **Task 10: Create Preview API and Integration** (AC: 1, 6, 8)
  - [ ] Create src/routes/api/preview.ts
  - [ ] Implement preview endpoints:
    - POST /api/preview/generate/:compositionId - Generate preview
    - GET /api/preview/:id - Get preview details
    - GET /api/preview/:id/stream - Stream preview video
    - POST /api/preview/:id/share - Create shareable link
    - GET /api/preview/shared/:token - Access shared preview
  - [ ] Add preview management endpoints:
    - GET /api/preview/:id/thumbnails - Get thumbnail collection
    - POST /api/preview/:id/feedback - Submit feedback
    - GET /api/preview/:id/feedback - Get feedback list
    - PUT /api/preview/:id/quality - Update quality settings
    - DELETE /api/preview/:id - Delete preview
  - [ ] Create WebSocket integration:
    - Real-time generation progress
    - Live feedback updates
    - Collaborative viewing sessions
    - Preview status notifications
  - [ ] Test API performance and security

## Dev Notes

### Architecture Context

- **Preview Engine:** Optimized Remotion rendering with quality shortcuts
- **Storage:** Cached previews in S3/filesystem with database metadata
- **Streaming:** HLS/DASH streaming for large preview files
- **Real-time:** WebSocket for collaborative features and progress updates

### Preview Generation Flow

```
Composition Ready → Quality Selection → Fast Rendering →
Thumbnail Generation → Cache Storage → Preview Ready →
Sharing/Collaboration
```

### Preview Quality Tiers

```typescript
interface PreviewQuality {
  name: string;
  resolution: { width: number; height: number };
  fps: number;
  bitrate: number;
  audio_bitrate: number;
  effects_complexity: "minimal" | "reduced" | "full";
  estimated_time: number; // seconds
}

const QUALITY_TIERS: Record<string, PreviewQuality> = {
  draft: {
    name: "Draft",
    resolution: { width: 640, height: 360 },
    fps: 15,
    bitrate: 500, // kbps
    audio_bitrate: 64,
    effects_complexity: "minimal",
    estimated_time: 15,
  },
  review: {
    name: "Review",
    resolution: { width: 1280, height: 720 },
    fps: 24,
    bitrate: 1500,
    audio_bitrate: 128,
    effects_complexity: "reduced",
    estimated_time: 30,
  },
  preview: {
    name: "Preview",
    resolution: { width: 1920, height: 1080 },
    fps: 30,
    bitrate: 4000,
    audio_bitrate: 192,
    effects_complexity: "full",
    estimated_time: 60,
  },
};
```

### Fast Rendering Optimizations

```typescript
class PreviewOptimizer {
  optimizeForSpeed(
    composition: VideoComposition,
    quality: PreviewQuality,
  ): OptimizedComposition {
    return {
      ...composition,
      // Reduce visual effects complexity
      effects: this.simplifyEffects(
        composition.effects,
        quality.effects_complexity,
      ),

      // Use proxy assets for large media
      assets: composition.assets.map((asset) => ({
        ...asset,
        src: this.getProxyAsset(asset, quality.resolution),
      })),

      // Optimize transition effects
      transitions: this.simplifyTransitions(composition.transitions),

      // Reduce audio processing
      audio: this.optimizeAudio(composition.audio, quality.audio_bitrate),
    };
  }

  private simplifyEffects(
    effects: VisualEffect[],
    complexity: string,
  ): VisualEffect[] {
    switch (complexity) {
      case "minimal":
        return effects.filter((effect) => effect.essential);
      case "reduced":
        return effects.map((effect) => ({ ...effect, quality: 0.5 }));
      default:
        return effects;
    }
  }
}
```

### Thumbnail Generation System

```typescript
interface ThumbnailConfig {
  interval: number; // seconds between thumbnails
  width: number;
  height: number;
  quality: number; // 0-100
  format: "jpg" | "webp";
}

class ThumbnailGenerator {
  async generateThumbnails(
    videoPath: string,
    config: ThumbnailConfig,
  ): Promise<Thumbnail[]> {
    const videoDuration = await this.getVideoDuration(videoPath);
    const thumbnailCount = Math.ceil(videoDuration / config.interval);
    const thumbnails: Thumbnail[] = [];

    for (let i = 0; i < thumbnailCount; i++) {
      const timestamp = i * config.interval;
      const thumbnail = await this.extractFrame(videoPath, timestamp, config);
      thumbnails.push({
        timestamp,
        url: thumbnail.url,
        width: config.width,
        height: config.height,
      });
    }

    return thumbnails;
  }
}
```

### Preview Player Component

```typescript
const PreviewPlayer: React.FC<{
  previewUrl: string;
  thumbnails: Thumbnail[];
  scenes: SceneMarker[];
  onTimeUpdate: (time: number) => void;
}> = ({ previewUrl, thumbnails, scenes, onTimeUpdate }) => {
  const videoRef = useRef<HTMLVideoElement>(null);
  const [currentTime, setCurrentTime] = useState(0);
  const [isPlaying, setIsPlaying] = useState(false);

  return (
    <div className="preview-player">
      <video
        ref={videoRef}
        src={previewUrl}
        onTimeUpdate={(e) => {
          const time = e.currentTarget.currentTime;
          setCurrentTime(time);
          onTimeUpdate(time);
        }}
      />

      <Timeline
        duration={videoDuration}
        currentTime={currentTime}
        thumbnails={thumbnails}
        scenes={scenes}
        onSeek={(time) => {
          if (videoRef.current) {
            videoRef.current.currentTime = time;
          }
        }}
      />

      <Controls
        isPlaying={isPlaying}
        onPlay={() => videoRef.current?.play()}
        onPause={() => videoRef.current?.pause()}
        onFullscreen={() => videoRef.current?.requestFullscreen()}
      />
    </div>
  );
};
```

### Feedback and Annotation System

```typescript
interface VideoFeedback {
  id: string;
  previewId: string;
  userId: string;
  timestamp: number;
  type: "comment" | "issue" | "approval";
  content: string;
  priority: "low" | "medium" | "high";
  status: "open" | "resolved" | "dismissed";
  position?: { x: number; y: number }; // For visual annotations
  createdAt: Date;
  updatedAt: Date;
}

interface AnnotationMarker {
  timestamp: number;
  feedbackId: string;
  type: "comment" | "issue";
  resolved: boolean;
}
```

### Database Schema Updates

```sql
-- Video previews and metadata
CREATE TABLE video_previews (
  id TEXT PRIMARY KEY,
  composition_id TEXT REFERENCES video_compositions(id),
  quality_tier TEXT,
  file_path TEXT,
  thumbnail_path TEXT,
  duration REAL,
  resolution TEXT,
  file_size INTEGER,
  generated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP,
  view_count INTEGER DEFAULT 0
);

-- Preview sharing and access
CREATE TABLE preview_shares (
  id TEXT PRIMARY KEY,
  preview_id TEXT REFERENCES video_previews(id),
  share_token TEXT UNIQUE,
  password_hash TEXT,
  permissions JSON,
  expires_at TIMESTAMP,
  created_by TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  access_count INTEGER DEFAULT 0
);

-- Preview feedback and annotations
CREATE TABLE preview_feedback (
  id TEXT PRIMARY KEY,
  preview_id TEXT REFERENCES video_previews(id),
  user_id TEXT,
  timestamp REAL,
  feedback_type TEXT,
  content TEXT,
  priority TEXT,
  status TEXT DEFAULT 'open',
  position JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Preview thumbnails
CREATE TABLE preview_thumbnails (
  id TEXT PRIMARY KEY,
  preview_id TEXT REFERENCES video_previews(id),
  timestamp REAL,
  file_path TEXT,
  width INTEGER,
  height INTEGER,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Performance Considerations

- Use progressive video loading for large previews
- Implement thumbnail lazy loading and caching
- Optimize preview streaming with adaptive bitrate
- Cache frequently accessed previews
- Use CDN for global preview distribution

### Testing Standards

- Preview generation speed and quality tests
- Player functionality across browsers tests
- Collaboration feature integration tests
- Caching system performance tests
- Security testing for shared previews

## Change Log

| Date       | Version | Description            | Author    |
| ---------- | ------- | ---------------------- | --------- |
| 2025-08-26 | 1.0     | Initial story creation | John (PM) |

## Dev Agent Record

(To be populated during implementation)

## QA Results

(To be populated during QA review)
