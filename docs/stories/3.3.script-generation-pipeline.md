# Story 3.3: Script Generation Pipeline

## Status

Draft

## Story

**As a** content creator,  
**I want** automated script generation from approved Reddit posts using AI,  
**so that** I can transform raw content into structured video scripts with scene breakdowns and YouTube metadata.

## Acceptance Criteria

1. Pipeline automatically triggers script generation when posts are approved
2. Claude API integration produces structured scripts with consistent formatting
3. Scene breakdown splits content into 3-7 scenes with timing estimates
4. Keyword extraction identifies visual assets needed for each scene
5. YouTube metadata generated (5 titles, description, thumbnail concepts)
6. Script versioning tracks generations and allows rollbacks
7. Error handling gracefully manages API failures and retries
8. Generation queue processes multiple requests efficiently
9. WebSocket notifications update dashboard with generation progress

## Tasks / Subtasks

- [ ] **Task 1: Build Script Generation Service** (AC: 1, 2, 7)
  - [ ] Create src/services/scriptGeneration/generator.ts
  - [ ] Implement generateScript function:
    - Accept approved RedditPost
    - Format Claude API prompt
    - Execute API call with error handling
    - Parse and validate response
    - Store result in database
  - [ ] Add generation parameters:
    - Target video duration (30-120 seconds)
    - Tone preference (motivational, contemplative, urgent)
    - Scene count preference (3-7 scenes)
  - [ ] Implement error handling:
    - API timeout recovery
    - Malformed response handling
    - Retry logic with exponential backoff
    - Fallback prompt strategies
  - [ ] Test with various Reddit post types

- [ ] **Task 2: Design Advanced Prompt Engineering** (AC: 2, 3, 4, 5)
  - [ ] Create src/services/scriptGeneration/prompts.ts
  - [ ] Build comprehensive system prompt:
    - Role definition as professional video scriptwriter
    - Output format specification (structured JSON)
    - Style guide for motivational content
    - Constraints and requirements
  - [ ] Design user prompt template:
    - Reddit post context insertion
    - Duration and scene requirements
    - Keyword extraction instructions
    - Metadata generation requirements
  - [ ] Create prompt variations:
    - Different emotional tones
    - Various content lengths
    - Specific scene count requests
  - [ ] Add prompt optimization:
    - Token usage optimization
    - Response consistency improvement
    - Quality control instructions

- [ ] **Task 3: Implement Scene Breakdown Logic** (AC: 3, 4)
  - [ ] Create scene processing service:
    - Parse Claude response into scenes
    - Validate scene structure
    - Calculate timing estimates
    - Extract keywords per scene
  - [ ] Build scene validation:
    - Minimum/maximum scene count
    - Scene duration balance
    - Content coverage verification
    - Transition smoothness check
  - [ ] Add scene enhancement:
    - Auto-generate scene titles
    - Identify scene emotional tone
    - Suggest visual concepts
    - Calculate optimal pacing
  - [ ] Create scene timing algorithm:
    - Words per minute calculation
    - Pause estimation
    - Scene transition timing
    - Total duration validation

- [ ] **Task 4: Build Metadata Generation** (AC: 5)
  - [ ] Implement YouTube title generation:
    - Create 5 title variations
    - Optimize for CTR and SEO
    - Include trending keywords
    - Maintain under 60 characters
  - [ ] Build description generator:
    - Compelling hook opening
    - Key points summary
    - Relevant hashtags
    - Call-to-action
  - [ ] Create thumbnail concepts:
    - Visual theme suggestions
    - Text overlay concepts
    - Emotional style guidance
    - Color scheme recommendations
  - [ ] Add SEO optimization:
    - Keyword research integration
    - Trending topic alignment
    - Search volume optimization

- [ ] **Task 5: Implement Script Versioning** (AC: 6)
  - [ ] Create version management system:
    - Auto-increment version numbers
    - Store generation parameters
    - Maintain version history
    - Enable version comparison
  - [ ] Build version operations:
    - Create new version
    - Revert to previous version
    - Delete old versions
    - Export version differences
  - [ ] Add version metadata:
    - Generation timestamp
    - Claude model used
    - Prompt version
    - Quality metrics
  - [ ] Test version workflows

- [ ] **Task 6: Create Generation Queue System** (AC: 8, 9)
  - [ ] Build queue management:
    - FIFO processing order
    - Priority queue for urgent requests
    - Concurrent generation limits
    - Queue status monitoring
  - [ ] Implement job processing:
    - Job creation and tracking
    - Progress updates
    - Error handling and retries
    - Completion notifications
  - [ ] Add queue monitoring:
    - Queue length tracking
    - Processing time metrics
    - Error rate monitoring
    - Performance analytics
  - [ ] Create WebSocket integration:
    - Real-time progress updates
    - Queue position notifications
    - Completion announcements

- [ ] **Task 7: Build Pipeline Orchestration** (AC: 1, 9)
  - [ ] Create pipeline controller:
    - Listen for post approval events
    - Trigger script generation automatically
    - Handle pipeline failures
    - Coordinate next pipeline steps
  - [ ] Implement workflow state:
    - Track pipeline progress
    - Update post status
    - Handle state transitions
    - Maintain workflow integrity
  - [ ] Add pipeline monitoring:
    - Success/failure tracking
    - Performance metrics
    - Bottleneck identification
    - Alert system for failures
  - [ ] Create manual pipeline triggers

- [ ] **Task 8: Implement Content Validation** (AC: 2, 3, 4)
  - [ ] Create script quality validation:
    - Structure completeness check
    - Scene count verification
    - Duration estimate validation
    - Keyword extraction verification
  - [ ] Build content quality scoring:
    - Coherence assessment
    - Engagement potential scoring
    - Visual concept richness
    - Metadata quality check
  - [ ] Add validation reporting:
    - Quality score calculation
    - Issue identification
    - Improvement suggestions
    - Validation pass/fail status
  - [ ] Implement auto-retry logic:
    - Quality threshold enforcement
    - Automatic regeneration triggers
    - Maximum retry limits

- [ ] **Task 9: Create API Endpoints and Integration** (AC: 1, 6, 8)
  - [ ] Create src/routes/api/scripts.ts
  - [ ] Implement script endpoints:
    - POST /api/scripts/generate - Trigger generation
    - GET /api/scripts/:id - Retrieve script
    - GET /api/scripts/:id/versions - List versions
    - POST /api/scripts/:id/regenerate - Regenerate script
    - GET /api/generation/queue - Queue status
  - [ ] Add request validation
  - [ ] Implement response formatting
  - [ ] Create error responses
  - [ ] Add authentication/authorization
  - [ ] Test endpoint functionality

## Dev Notes

### Architecture Context

- **AI Service:** Claude 3.5 Sonnet via Anthropic API
- **Processing:** Queue-based with concurrent limits
- **Storage:** Database with JSON fields for structured data
- **Real-time:** WebSocket updates for progress

### Script Generation Flow

```
Approved Post → Queue → Claude API → Parse Response →
Scene Analysis → Metadata Generation → Database Storage →
WebSocket Notification
```

### Claude Response Structure

```typescript
interface ClaudeScriptResponse {
  script_content: string;
  scene_breakdown: {
    scene_number: number;
    content: string;
    keywords: string[];
    duration_estimate: number;
    emotional_tone: string;
  }[];
  youtube_metadata: {
    titles: string[];
    description: string;
    thumbnail_concepts: string[];
    hashtags: string[];
  };
  total_duration: number;
  generation_notes: string;
}
```

### Scene Timing Calculation

```typescript
// Words per minute for different content types
const WPM_RATES = {
  motivational: 160, // Energetic delivery
  contemplative: 140, // Thoughtful pace
  urgent: 180, // Fast-paced delivery
  default: 150, // Standard pace
};

sceneTimeMs = (wordCount / wpmRate) * 60 * 1000;
```

### Database Schema Updates

```sql
-- Add script generation tracking
ALTER TABLE video_scripts ADD COLUMN generation_queue_id TEXT;
ALTER TABLE video_scripts ADD COLUMN generation_started_at TIMESTAMP;
ALTER TABLE video_scripts ADD COLUMN generation_completed_at TIMESTAMP;
ALTER TABLE video_scripts ADD COLUMN claude_model TEXT;
ALTER TABLE video_scripts ADD COLUMN prompt_version TEXT;

-- Queue table for generation jobs
CREATE TABLE generation_queue (
  id TEXT PRIMARY KEY,
  post_id TEXT REFERENCES reddit_posts(id),
  status TEXT CHECK (status IN ('pending', 'processing', 'completed', 'failed')),
  priority INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  error_message TEXT
);
```

### Testing Standards

- Mock Claude API responses
- Test queue processing under load
- Validate scene breakdown accuracy
- Test version management workflows
- Performance testing with concurrent generations

## Change Log

| Date       | Version | Description            | Author    |
| ---------- | ------- | ---------------------- | --------- |
| 2025-08-26 | 1.0     | Initial story creation | John (PM) |

## Dev Agent Record

(To be populated during implementation)

## QA Results

(To be populated during QA review)
