# Story 3.3: Script Generation Pipeline

## Status

In Progress - Task 5 Complete

## Story

**As a** content creator,  
**I want** automated script generation from approved Reddit posts using Claude Code subscription,  
**so that** I can transform raw content into structured video scripts with scene breakdowns and YouTube metadata without manual scripting work.

## Acceptance Criteria

1. Pipeline automatically triggers script generation when posts are approved (status: 'idea_selected')
2. Claude Code integration produces structured scripts with consistent JSON formatting
3. Scene breakdown splits content into 3-7 scenes with timing estimates and keywords
4. Keyword extraction identifies visual assets needed for each scene
5. YouTube metadata generated (5 titles, description, thumbnail concepts)
6. Script versioning tracks generations and allows rollbacks
7. Error handling gracefully manages generation failures and implements retry logic
8. Generation queue processes multiple requests efficiently with WebSocket progress updates
9. Content validation ensures scripts meet quality standards and duration targets

## Tasks / Subtasks

- [x] **Task 1: Core Script Generation Service** (AC: 1, 2, 7) ✅ **COMPLETED**
  - [x] Existing: `apps/server/src/services/claude-code/scriptGenerator.ts`
  - [x] Core generation function with Claude Code integration
  - [x] Parameter configuration (duration, style, scene count)
  - [x] Comprehensive error handling and validation
  - [x] Multiple script style support (motivational, educational, entertainment, storytelling)
  - [x] Script regeneration and variation generation capabilities

- [x] **Task 2: Advanced Prompt Engineering** (AC: 2, 3, 4, 5) ✅ **COMPLETED**
  - [x] Existing: `apps/server/src/services/claude-code/prompts.ts`
  - [x] System prompts for different script styles
  - [x] Structured JSON output enforcement
  - [x] Scene breakdown and timing specifications
  - [x] YouTube metadata generation requirements
  - [x] Content optimization prompts

- [x] **Task 3: Scene Breakdown Logic** (AC: 3, 4) ✅ **COMPLETED**
  - [x] Existing scene processing in `scriptGenerator.ts`
  - [x] JSON response parsing into SceneData arrays
  - [x] Timing calculation with optimal scene distribution
  - [x] Visual keyword extraction per scene
  - [x] Scene count optimization based on duration
  - [x] Emotion classification and visual element mapping

- [x] **Task 4: YouTube Metadata Generation** (AC: 5) ✅ **COMPLETED**
  - [x] Existing metadata generation in `prompts.ts` and `scriptGenerator.ts`
  - [x] Generate 5 title variations with SEO optimization
  - [x] Compelling YouTube descriptions with hashtags
  - [x] Thumbnail concept generation with visual elements
  - [x] Comprehensive tagging system for discoverability
  - [x] Character limit validation and optimization

- [x] **Task 5: Implement Script Versioning System** (AC: 6) ✅ **COMPLETED**
  - [x] Update database schema in `apps/server/migrations/`:
    - [x] Add version tracking to video_scripts table
    - [x] Create script_versions table for history
    - [x] Add foreign key relationships
    - [x] Include generation metadata (timestamp, model, prompt version)
  - [x] Build version management in scriptVersionManager.ts:
    - [x] Auto-increment version numbers per post
    - [x] Store complete generation context
    - [x] Maintain version history with metadata
    - [x] Enable version comparison functionality
  - [x] Create version operations:
    - [x] Generate new version with incremental numbering
    - [x] Revert to previous version with status preservation
    - [x] Delete unnecessary old versions (keep last 5)
    - [x] Export version differences for review
  - [x] Add version metadata tracking:
    - [x] Generation timestamp and duration
    - [x] Claude Code model/configuration used
    - [x] Prompt version and parameters
    - [x] Quality score and validation results

- [ ] **Task 6: Create Generation Queue System** (AC: 8, 9)
  - [ ] Build queue management in `apps/server/src/queue/`:
    - FIFO processing order with priority support
    - Concurrent generation limits (max 3 simultaneous)
    - Queue status monitoring and metrics
    - Job persistence for reliability
  - [ ] Implement job processing workflow:
    - Job creation with unique ID and metadata
    - Progress tracking with percentage completion
    - Error handling with retry attempts
    - Completion notifications via WebSocket
  - [ ] Add queue monitoring capabilities:
    - Queue length and processing time tracking
    - Error rate monitoring and alerting
    - Performance analytics and bottleneck identification
    - Health check endpoints for monitoring
  - [ ] Create WebSocket integration:
    - Real-time progress updates during generation
    - Queue position notifications for waiting jobs
    - Completion announcements with script preview
    - Error notifications with retry information

- [ ] **Task 7: Build Pipeline Orchestration** (AC: 1, 9)
  - [ ] Create pipeline controller in `apps/server/src/services/`:
    - Listen for post status change to 'idea_selected'
    - Automatically trigger script generation queue job
    - Handle pipeline state transitions
    - Coordinate with next pipeline steps (asset generation)
  - [ ] Implement workflow state management:
    - Track pipeline progress across all stages
    - Update RedditPost status to 'script_generated' on completion
    - Handle state rollback on failures
    - Maintain workflow integrity and consistency
  - [ ] Add pipeline monitoring and metrics:
    - Success/failure rate tracking
    - Average generation time monitoring
    - Bottleneck identification and reporting
    - Alert system for pipeline failures
  - [ ] Create manual pipeline triggers for testing and recovery

- [ ] **Task 8: Implement Content Validation** (AC: 9)
  - [ ] Create script quality validation in generator.ts:
    - Structure completeness verification (all required fields)
    - Scene count and duration validation
    - Keyword extraction quality assessment
    - Metadata completeness verification
  - [ ] Build content quality scoring system:
    - Script coherence assessment using NLP metrics
    - Engagement potential scoring based on content patterns
    - Visual concept richness evaluation
    - YouTube metadata optimization score
  - [ ] Add validation reporting:
    - Comprehensive quality score calculation (0-100)
    - Specific issue identification and categorization
    - Improvement suggestions for failed validations
    - Pass/fail determination with thresholds
  - [ ] Implement auto-retry logic:
    - Quality threshold enforcement (minimum score: 70)
    - Automatic regeneration triggers for low scores
    - Maximum retry limits (3 attempts per post)
    - Escalation to manual review for persistent failures

- [ ] **Task 5: Create API Endpoints and Integration** (AC: 1, 6, 8)
  - [ ] Create `apps/server/src/routes/api/scripts.ts`
  - [ ] Integrate existing `claude-code` service with API endpoints:
    - `POST /api/scripts/generate` - Use ClaudeCodeScriptGenerator.generateScript()
    - `GET /api/scripts/:postId` - Retrieve script by post ID
    - `GET /api/scripts/:postId/versions` - List all versions
    - `POST /api/scripts/:postId/regenerate` - Use regenerateScript() method
    - `GET /api/generation/queue` - Queue status and position
  - [ ] Add comprehensive request validation and response formatting
  - [ ] Create error handling, logging, and test suite

## Dev Notes

### Architecture Context

[Source: docs/architecture/tech-stack.md]

- **AI Service:** Claude Code subscription (not separate Claude API) - leveraging existing subscription
- **Backend Framework:** Fastify 4.0+ with TypeScript for high-performance HTTP and WebSocket support
- **Database:** SQLite for development, PostgreSQL 15+ for production with full transaction support
- **Queue Management:** Node.js-based queue system with Redis for production scaling
- **Real-time Updates:** WebSocket integration for live progress notifications
- **State Management:** Zustand 4.4+ for frontend state management with TypeScript support

### Previous Story Insights

[From Story 3.1 completion]

- WebSocket infrastructure already established and working
- Batch operations pattern established for UI interactions
- Real-time update patterns successfully implemented
- Database transaction patterns validated and working
- Error handling patterns established for external API failures

### Data Models

[Source: docs/architecture/data-models.md]

**VideoScript Interface:**

```typescript
interface VideoScript {
  id: string;
  post_id: string;
  script_content: string;
  scene_breakdown: SceneData[];
  duration_target: number;
  titles: string[];
  description: string;
  thumbnail_suggestions: ThumbnailConcept[];
  version: number;
  approved: boolean;
  generated_at: Date;
  approved_at?: Date;
}

interface SceneData {
  scene_number: number;
  content: string;
  keywords: string[];
  duration_estimate: number;
  emotional_tone: 'motivational' | 'contemplative' | 'urgent';
}

interface ThumbnailConcept {
  text_overlay: string;
  emotional_style: string;
  visual_theme: string;
}
```

**ProcessingStatus Flow:**
`'idea'` → `'idea_selected'` → `'script_generated'` → `'script_approved'`

### API Specifications

[Source: docs/architecture/external-apis.md]

**Claude Code Integration:**

- Use existing Claude Code subscription for content generation
- Implement structured prompts for consistent video script output
- Handle token limits with content chunking for long Reddit posts
- System prompts to maintain video script quality standards
- Response format: Structured JSON with script, scenes, and metadata

**Database Schema Requirements:**

```sql
-- Extended video_scripts table
ALTER TABLE video_scripts ADD COLUMN generation_queue_id TEXT;
ALTER TABLE video_scripts ADD COLUMN generation_started_at TIMESTAMP;
ALTER TABLE video_scripts ADD COLUMN generation_completed_at TIMESTAMP;
ALTER TABLE video_scripts ADD COLUMN claude_model TEXT;
ALTER TABLE video_scripts ADD COLUMN prompt_version TEXT;
ALTER TABLE video_scripts ADD COLUMN quality_score INTEGER;

-- Generation queue table
CREATE TABLE generation_queue (
  id TEXT PRIMARY KEY,
  post_id TEXT REFERENCES reddit_posts(id),
  status TEXT CHECK (status IN ('pending', 'processing', 'completed', 'failed')),
  priority INTEGER DEFAULT 0,
  attempts INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  error_message TEXT,
  progress_percentage INTEGER DEFAULT 0
);
```

### File Locations

[Source: docs/architecture/unified-project-structure.md]

**Existing Claude Code Implementation:** ✅ **FOUNDATION COMPLETE**

- `apps/server/src/services/claude-code/scriptGenerator.ts` - Core generation logic ✅
- `apps/server/src/services/claude-code/prompts.ts` - Advanced prompt templates ✅
- `apps/server/src/services/claude-code/types.ts` - TypeScript interfaces ✅
- `apps/server/src/services/claude-code/contentProcessor.ts` - Reddit post processing ✅
- `apps/server/src/services/claude-code/index.ts` - Service exports ✅

**New Files to Create:**

- `apps/server/src/queue/generationQueue.ts` - Queue management system
- `apps/server/src/routes/api/scripts.ts` - Script management API endpoints
- `apps/server/migrations/005_add_script_generation.sql` - Database schema updates

**Existing Files to Modify:**

- `apps/server/src/models/videoScript.ts` - Add new fields and methods
- `apps/server/src/server.ts` - Register new API routes and queue initialization
- `packages/shared/src/types/models.ts` - Update interfaces with new fields

### Component Specifications

[Source: docs/architecture/frontend-architecture.md]

**Frontend Integration Points:**

- WebSocket listeners in existing `useSimpleWebSocket.ts` hook
- State updates via Zustand store for script generation status
- UI components for script review and version management
- Real-time progress indicators during generation process

### Technical Constraints

[Source: docs/architecture/tech-stack.md]

- TypeScript 5.0+ for full type safety across frontend/backend
- Fastify plugins for structured route organization
- Winston 3.11+ for structured logging and debugging
- Error handling must follow established patterns from previous stories
- Database transactions required for data consistency
- WebSocket message format must match existing patterns

### Testing Standards

**Test File Locations:**

- `apps/server/tests/services/scriptGeneration/` - Service layer tests
- `apps/server/tests/routes/api/scripts.test.ts` - API endpoint tests
- `apps/server/tests/queue/generationQueue.test.ts` - Queue system tests

**Testing Requirements:**

- Vitest 1.0+ and Supertest 6.3+ for backend API testing
- Mock Claude Code API responses for consistent testing
- Queue processing tests under concurrent load scenarios
- Database transaction rollback testing for error conditions
- WebSocket message validation tests
- Integration tests for full pipeline workflow (post approval → script generation)

**Testing Patterns:**

- Service layer unit tests with dependency injection
- API integration tests with test database
- Queue system stress testing with multiple concurrent jobs
- Error scenario testing with various failure modes
- Performance testing for generation time optimization

## Change Log

| Date       | Version | Description                                 | Author             |
| ---------- | ------- | ------------------------------------------- | ------------------ |
| 2025-08-28 | 1.0     | Initial story creation                      | John (PM)          |
| 2025-08-28 | 1.1     | Updated for Claude Code subscription        | Bob (Scrum Master) |
| 2025-08-28 | 1.2     | Updated to leverage existing implementation | Bob (Scrum Master) |

## Dev Agent Record

### Task 5 Implementation - James (Dev Agent) - 2025-08-28

**Implemented:** Script Versioning System

- ✅ Created database migration `005_add_script_generation.sql` with comprehensive versioning schema
- ✅ Built `ScriptVersionManager` service with full CRUD operations and version control
- ✅ Updated shared types in `packages/shared/src/types/models.ts`
- ✅ Implemented version operations: create, revert, cleanup, compare
- ✅ Added quality scoring and metadata tracking
- ✅ Comprehensive test suite with 18 passing tests

**Files Created:**

- `apps/server/migrations/005_add_script_generation.sql` - Database schema
- `apps/server/src/services/scriptVersionManager.ts` - Core service
- `apps/server/src/services/scriptVersionManager.test.ts` - Test suite

**Files Modified:**

- `packages/shared/src/types/models.ts` - Added versioning types

**Key Features:**

- Auto-incrementing version numbers per post
- Active version tracking with single-active constraint
- Version metadata (generation time, model, quality score)
- Automatic cleanup (keeps last 5 versions)
- Version comparison and diff functionality
- Full transaction safety with SQLite integration

### File List

**Created Files:**

- `apps/server/migrations/005_add_script_generation.sql`
- `apps/server/src/services/scriptVersionManager.ts`
- `apps/server/src/services/scriptVersionManager.test.ts`

**Modified Files:**

- `packages/shared/src/types/models.ts`
- `packages/shared/src/index.ts`

## QA Results

(To be populated during QA review)
